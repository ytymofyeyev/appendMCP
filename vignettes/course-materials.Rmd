---
title: "Course materials"
output: 
  rmarkdown::html_vignette:
    toc: TRUE
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Course materials}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Practicals

## Simple GSD optimization

**Description:**

Set an optimization criterion as a function of parameter(s).\
Use numerical solvers, e.g., `stats::nlminb()`.

**Exercise:**

-   Explore how the optimal parameter changes for a 3-stage design with
respect to different alpha, beta and timing of analysis. 

-   Find an optimal WT boundary for OS using KEYNOTE-598 study setting

```{r}
library(gsDesign)

opt_fun <- function(
    x,                 # optimization parameter
    timing,            # timing of IAs
    delta ,            # target effect size 
    theta,             # effect size vector for which to get expected value N
    thetawgt,          # corresponing weight
    k = length(timing),# number of analysis
    alpha,             # Type I 
    beta,              # Type II
    sfu = "WT"
) {
  # Derive design
  d <- gsDesign(
    k = k,            
    timing = timing,   
    test.type = 1,     
    alpha     = alpha, 
    beta      = beta,  
    delta     = delta, 
    sfu = "WT",        
    sfupar = x[1]     
  )
  # Compute boundary crossing probabilities for input theta
  y <- gsProbability(theta = theta, d = d)
  # Compute weighted average of expected values of N 
  sp_1 <- head(y$upper$prob,-1)
  en <- sum(y$n.I * c(sp_1, 1 - sum(sp_1)))
  en <- sum(as.vector(en) * as.vector(thetawgt))
  return(en)
}


effect_size_H1 <- -log(0.70)/2  # standardized effect size under H1
beta_target  <- 0.20
alpha_target <- 0.025
IA_timing    <- (1:3)/3

# Call optimizer 
x <- nlminb(
  start = c(0.15),    # starting value for opt_fun
  opt_fun,            # function to optimize
                      # other fixed parameters
  k = 3,
  timing   = IA_timing,
  alpha    = alpha_target,
  beta     = beta_target,
  delta    = effect_size_H1,  # effect size under alternative
  theta    = effect_size_H1,  # to compute EN under H1
  thetawgt = 1,
)
# Optimal value of parameter for WT boundary
x$par

# optimization function value at optimal 
x$objective
```
 
Design details:
 
```{r}
gsDesign(
  k = 3,
  test.type = 1,
  delta = effect_size_H1,
  alpha = alpha_target,
  beta  = beta_target,
  timing = IA_timing,
  sfu = "WT",
  sfupar = x$par
)
```

Compare with WT(0.389)

```{r}
gsDesign(
  k = 3,
  test.type = 1,
  delta = effect_size_H1,
  alpha = alpha_target,
  beta  = beta_target,
  timing = IA_timing,
  sfu = "WT",
  sfupar = 0.389
)
```


Compare with a Lan-DeMets O'Brien-Fleming
spending function

```{r}
gsDesign(
  k = 3,
  test.type = 1,
  delta = effect_size_H1,
  alpha = alpha_target,
  beta  = beta_target,
  timing = IA_timing,
  sfu = sfLDOF
)
```

